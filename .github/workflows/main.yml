name: Build, Test, and Deploy Bookstore App

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
          
      - name: Run tests
        run: |
          cd bookstore
          mvn clean test

  build-and-deploy:
    runs-on: self-hosted
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
          
      - name: Build Project
        run: |
          cd bookstore
          mvn clean package -DskipTests
          
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: bookstore/target/*.jar
          
      - name: Stop existing containers
        run: |
          cd bookstore
          docker-compose down || true
          
      - name: Build and deploy with Docker Compose
        run: |
          cd bookstore
          docker-compose up -d --build
          
      - name: Wait for containers to start
        run: |
          echo "Waiting for containers to start..."
          sleep 15
          
      - name: Check deployment status
        run: |
          cd bookstore
          echo "=== Container Status ==="
          docker-compose ps
          echo ""
          echo "=== Application Logs ==="
          docker-compose logs app --tail=20
          echo ""
          echo "=== Database Logs ==="
          docker-compose logs db --tail=10
          echo ""
          echo "‚úÖ Deployment completed!"
          echo "üåê Application should be available at: http://localhost:8080"
