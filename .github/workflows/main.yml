name: Build, Test, and Deploy Bookstore App (Simplified)

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  APP_NAME: 'bookstore'
  DEPLOY_PORT: '8080'
  # SonarQube Configuration
  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}  # e.g., https://sonarcloud.io or http://localhost:9000
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  test:
    name: Run Tests & Code Coverage
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important for SonarQube analysis
        
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven
          
      - name: Make Maven wrapper executable
        run: |
          cd ${{ env.APP_NAME }}
          chmod +x ./mvnw
          
      - name: Verify Maven wrapper
        run: |
          cd ${{ env.APP_NAME }}
          ls -la ./mvnw
          ./mvnw --version
          
      - name: Run tests with coverage
        run: |
          cd ${{ env.APP_NAME }}
          ./mvnw clean test jacoco:report --batch-mode --no-transfer-progress
          
      - name: Generate test report
        if: always()
        run: |
          cd ${{ env.APP_NAME }}
          echo "=== Test Results ==="
          if [ -d "target/surefire-reports" ]; then
            find target/surefire-reports -name "*.xml" -exec grep -l "testcase" {} \; | wc -l | xargs echo "Test files found:"
            echo "Coverage report: target/site/jacoco/index.html"
          fi
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            ${{ env.APP_NAME }}/target/surefire-reports/
            ${{ env.APP_NAME }}/target/site/jacoco/
          retention-days: 5

  sonarqube-analysis:
    name: SonarQube Analysis
    runs-on: self-hosted
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
        
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven
          
      - name: Make Maven wrapper executable
        run: |
          cd ${{ env.APP_NAME }}
          chmod +x ./mvnw
          
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: ${{ env.APP_NAME }}/target/
          
      # Option 1: SonarCloud Analysis
      - name: SonarCloud Scan
        if: env.SONAR_HOST_URL == 'https://sonarcloud.io'
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        with:
          projectBaseDir: ${{ env.APP_NAME }}
          
      # Option 2: Self-hosted SonarQube Analysis
      - name: SonarQube Scan (Self-hosted)
        if: env.SONAR_HOST_URL != 'https://sonarcloud.io'
        run: |
          cd ${{ env.APP_NAME }}
          
          # Run tests and generate reports for SonarQube
          ./mvnw clean test jacoco:report --batch-mode --no-transfer-progress
          
          # Run SonarQube analysis
          ./mvnw sonar:sonar \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.login=${{ env.SONAR_TOKEN }} \
            -Dsonar.projectKey=${{ env.APP_NAME }} \
            -Dsonar.projectName="${{ env.APP_NAME }}" \
            -Dsonar.projectVersion=${{ github.sha }} \
            -Dsonar.sources=src/main/java \
            -Dsonar.tests=src/test/java \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.java.test.binaries=target/test-classes \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -Dsonar.junit.reportPaths=target/surefire-reports \
            --batch-mode --no-transfer-progress
            
      - name: Check SonarQube Quality Gate
        if: env.SONAR_HOST_URL != 'https://sonarcloud.io'
        run: |
          echo "Checking Quality Gate status..."
          # Wait a bit for SonarQube to process
          sleep 30
          
          # You can add quality gate check here if needed
          echo "‚úÖ SonarQube analysis completed"
          echo "üåê View results at: ${{ env.SONAR_HOST_URL }}"

  build:
    name: Build Application
    runs-on: self-hosted
    needs: [test, sonarqube-analysis]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven
          
      - name: Make Maven wrapper executable
        run: |
          cd ${{ env.APP_NAME }}
          chmod +x ./mvnw
          
      - name: Build application
        run: |
          cd ${{ env.APP_NAME }}
          ./mvnw clean package -DskipTests --batch-mode --no-transfer-progress
          
      - name: Verify JAR file
        run: |
          cd ${{ env.APP_NAME }}
          echo "=== Built JAR files ==="
          ls -la target/*.jar
          
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-jar
          path: ${{ env.APP_NAME }}/target/*.jar
          retention-days: 5

  security-scan:
    name: Basic Security Scan
    runs-on: self-hosted
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-jar
          path: ${{ env.APP_NAME }}/target/
          
      - name: Build Docker image for scanning
        run: |
          echo "Building Docker image for security scanning..."
          docker build -t ${{ env.APP_NAME }}:scan .
          
      - name: Install Trivy
        run: |
          # Install Trivy if not already installed
          if ! command -v trivy &> /dev/null; then
            sudo apt-get update
            sudo apt-get install wget apt-transport-https gnupg lsb-release -y
            wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
            echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
            sudo apt-get update
            sudo apt-get install trivy -y
          fi
          trivy --version
          
      - name: Run Trivy filesystem scan (optimized)
        run: |
          echo "=== Scanning source code ==="
          trivy fs \
            --scanners vuln \
            --severity HIGH,CRITICAL \
            --timeout 10m \
            --format table \
            --exit-code 0 \
            ${{ env.APP_NAME }}/
          
      - name: Run Trivy container scan (optimized)
        run: |
          echo "=== Scanning Docker image ==="
          # Quick scan with table output
          trivy image \
            --scanners vuln \
            --severity HIGH,CRITICAL \
            --timeout 20m \
            --format table \
            --exit-code 0 \
            ${{ env.APP_NAME }}:scan
          
          # Detailed scan with JSON output for artifacts
          trivy image \
            --scanners vuln \
            --severity HIGH,CRITICAL \
            --timeout 20m \
            --format json \
            --output trivy-report.json \
            ${{ env.APP_NAME }}:scan
          
      - name: Upload Trivy scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results
          path: trivy-report.json
          retention-days: 5
          
      - name: Show scan summary
        if: always()
        run: |
          echo "=== Scan Summary ==="
          if [ -f trivy-report.json ]; then
            echo "‚úÖ Trivy scan completed successfully"
            echo "üìÅ Report saved as trivy-report.json"
          else
            echo "‚ö†Ô∏è Trivy scan may have encountered issues"
          fi
          
  deploy:
    name: Deploy Application
    runs-on: self-hosted
    needs: [test, build, security-scan, sonarqube-analysis]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-jar
          path: ${{ env.APP_NAME }}/target/
          
      - name: Verify downloaded artifacts
        run: |
          cd ${{ env.APP_NAME }}
          echo "=== Downloaded artifacts ==="
          ls -la target/
          
      - name: Check Docker and Docker Compose
        run: |
          echo "=== Docker version ==="
          docker --version
          echo "=== Docker Compose version ==="
          docker-compose --version || docker compose version
          
      - name: Stop existing containers
        run: |
          echo "Stopping existing containers..."
          docker-compose down --remove-orphans || true
          
      - name: Clean up database volume (if needed)
        run: |
          echo "Cleaning up old database volume..."
          docker volume rm bookstore-ci-cd_db_data || true
          docker system prune -f || true
          
      - name: Build and deploy with Docker Compose
        run: |
          echo "Building and starting containers..."
          docker-compose up -d --build --force-recreate
          
      - name: Wait for application to start
        run: |
          echo "Waiting for application to start..."
          
          timeout=60
          counter=0
          
          while [ $counter -lt $timeout ]; do
            if docker-compose ps | grep -q "Up"; then
              echo "Containers are running, checking application health..."
              sleep 5
              
              if curl -f http://localhost:${{ env.DEPLOY_PORT }}/actuator/health 2>/dev/null || curl -f http://localhost:${{ env.DEPLOY_PORT }} 2>/dev/null; then
                echo "‚úÖ Application is responding!"
                break
              fi
            fi
            
            echo "Waiting... ($counter/$timeout)"
            sleep 2
            counter=$((counter + 2))
          done
          
          if [ $counter -ge $timeout ]; then
            echo "‚ö†Ô∏è Application may not be fully ready yet"
          fi
          
      - name: Final health check
        run: |
          echo "=== Final Health Check ==="
          
          if curl -f http://localhost:${{ env.DEPLOY_PORT }}/actuator/health 2>/dev/null; then
            echo "‚úÖ Health endpoint responding"
          elif curl -f http://localhost:${{ env.DEPLOY_PORT }} 2>/dev/null; then
            echo "‚úÖ Application endpoint responding"
          else
            echo "‚ö†Ô∏è Application may not be responding on port ${{ env.DEPLOY_PORT }}"
            echo "Container status:"
            docker-compose ps
          fi
          
          echo ""
          echo "üåê Application should be available at:"
          echo "   - http://localhost:${{ env.DEPLOY_PORT }}"